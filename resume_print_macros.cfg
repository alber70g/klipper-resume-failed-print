# Klipper Print Resume Macros
# Add this to your printer.cfg with: [include resume_print_macros.cfg]

[gcode_macro RESUME_PRINT]
description: Resume a failed print from specific Z height
gcode:
    {% set Z = params.Z|default(0)|float %}
    {% set FILENAME = params.FILENAME|default("") %}
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

    {% if FILENAME == "" %}
        { action_raise_error("FILENAME parameter required") }
    {% endif %}

    ; Save state
    SAVE_GCODE_STATE NAME=resume_state

    ; Re-apply temperatures (important!)
    M140 S{BED_TEMP}              ; Set bed temp
    M104 S{EXTRUDER_TEMP}         ; Set extruder temp
    M190 S{BED_TEMP}              ; Wait for bed temp
    M109 S{EXTRUDER_TEMP}         ; Wait for extruder temp

    ; Home XY
    G28 X Y

    ; Home Z at safe position
    ; Make sure safe_z_home is configured in printer.cfg
    SAFE_Z_HOME

    ; PAUSE for manual positioning
    PAUSE MSG="Manually position nozzle at resume height {Z}mm, then click resume"

    ; Set current Z position
    G92 Z{Z}

    ; Reset extruder position
    G92 E0

    ; Restore state and continue
    RESTORE_GCODE_STATE NAME=resume_state

    ; Start the print
    { action_respond_info("Print resuming from Z=%s" % Z) }

[gcode_macro SAFE_Z_HOME]
description: Home Z at a safe position away from the print
gcode:
    ; Customize these coordinates for your printer
    ; Default: X=0 Y=30 (adjust based on your printer's safe area)
    G90                           ; Absolute positioning
    G0 X0 Y30 F6000              ; Move to safe position
    G28 Z                        ; Home Z

[gcode_macro PREPARE_RESUME]
description: Prepare printer for resuming a failed print
gcode:
    {% set Z = params.Z|default(0)|float %}
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

    ; Heat bed and nozzle
    M140 S{BED_TEMP}              ; Set bed temp
    M104 S{EXTRUDER_TEMP}         ; Set extruder temp

    { action_respond_info("Heating bed to %sC and extruder to %sC" % (BED_TEMP, EXTRUDER_TEMP)) }

    M190 S{BED_TEMP}              ; Wait for bed temp
    M109 S{EXTRUDER_TEMP}         ; Wait for extruder temp

    { action_respond_info("Temperatures reached. Ready to home.") }

[gcode_macro MANUAL_POSITION_Z]
description: Helper macro for manually positioning Z height
gcode:
    {% set Z = params.Z|default(0)|float %}

    ; Disable steppers so you can manually move the nozzle
    M18 X Y Z E

    { action_respond_info("Steppers disabled. Manually position nozzle at Z=%smm with ~0.3mm clearance above the print surface." % Z) }
    { action_respond_info("Then run: SET_Z_POSITION Z=%s" % Z) }

[gcode_macro SET_Z_POSITION]
description: Set current Z position after manual positioning
gcode:
    {% set Z = params.Z|default(0)|float %}

    ; Re-enable steppers
    M17

    ; Set current position as the specified Z height
    G92 Z{Z}

    { action_respond_info("Z position set to %smm. Ready to resume printing." % Z) }

[gcode_macro CHECK_RESUME_HEIGHT]
description: Move nozzle to resume height to check clearance
gcode:
    {% set Z = params.Z|default(0)|float %}

    ; Move to resume height
    G90                           ; Absolute positioning
    G1 Z{Z} F300                 ; Move slowly to resume height

    { action_respond_info("Nozzle at Z=%smm. Check clearance above print surface." % Z) }
