# Example Klipper Configuration for Print Resume
# Add these sections to your printer.cfg

# ============================================
# INCLUDE THE RESUME MACROS
# ============================================
[include resume_print_macros.cfg]

# ============================================
# SAFE Z HOMING (if not already configured)
# ============================================
# This is required for the resume macros to work safely
# Adjust coordinates based on your printer size and safe homing location

[safe_z_home]
# Example for a 220x220 printer (Ender 3)
home_xy_position: 110,110  # Center of bed
# Example for a 300x300 printer (Voron/CoreXY)
# home_xy_position: 150,150

# Lift nozzle before homing Z
z_hop: 10
# Speed for the Z hop
z_hop_speed: 15.0

# ============================================
# PAUSE/RESUME CONFIGURATION
# ============================================
# These should already exist in your config, but here's a reference

[pause_resume]
# Optional: Set recover velocity after pause
recover_velocity: 50

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
    # Parameters
    {% set x_park = params.X|default(10)|float %}
    {% set y_park = params.Y|default(10)|float %}
    {% set z_lift = params.Z|default(10)|float %}

    # Save current state
    SAVE_GCODE_STATE NAME=PAUSE_state
    PAUSE_BASE

    # Lift Z and park
    G91
    G1 Z{z_lift} F600
    G90
    G1 X{x_park} Y{y_park} F6000

    # Disable filament sensor (if present)
    # SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
    # Enable filament sensor (if present)
    # SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1

    # Restore position
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    RESUME_BASE

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    # Turn off heaters
    TURN_OFF_HEATERS

    # Clear pause state
    CANCEL_PRINT_BASE

    # Disable filament sensor (if present)
    # SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0

    # Park toolhead
    G91
    G1 Z10 F600
    G90
    G28 X Y

    # Disable steppers
    M84

# ============================================
# ADDITIONAL HELPER MACROS
# ============================================

[gcode_macro PRINT_START]
description: Start print sequence with parameters
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

    # Heat bed
    M140 S{BED_TEMP}
    M190 S{BED_TEMP}

    # Heat nozzle to 150 for homing (prevents oozing)
    M104 S150

    # Home all axes
    G28

    # Move to purge position
    G0 X0 Y0 Z10 F6000

    # Heat to final temperature
    M109 S{EXTRUDER_TEMP}

    # Purge line (optional)
    G92 E0
    G1 X100 E15 F500
    G92 E0

[gcode_macro PRINT_END]
description: End print sequence
gcode:
    # Save current position
    SAVE_GCODE_STATE NAME=END_state

    # Retract filament
    G91
    G1 E-2 F300

    # Turn off heaters
    M140 S0
    M104 S0

    # Move nozzle away
    G91
    G1 Z10 F600
    G90
    G28 X Y

    # Turn off fan
    M107

    # Disable steppers
    M84

    # Restore state
    RESTORE_GCODE_STATE NAME=END_state

# ============================================
# CUSTOM RESUME CONFIGURATION
# ============================================
# You can override the default SAFE_Z_HOME from resume_print_macros.cfg

[gcode_macro SAFE_Z_HOME]
description: Custom safe Z home position for your printer
gcode:
    # Example for Ender 3 (220x220)
    G90
    G0 X110 Y110 F6000
    G28 Z

    # Example for Voron 2.4 (300x300)
    # G90
    # G0 X150 Y150 F6000
    # G28 Z

    # Example for Prusa-style (bed moves in Y)
    # G90
    # G0 X110 Y0 F6000
    # G28 Z

# ============================================
# POWER LOSS RECOVERY (Optional)
# ============================================
# For even better print recovery, consider adding power loss recovery
# This requires additional hardware (e.g., Raspberry Pi with UPS)

# [save_variables]
# filename: ~/printer_data/config/saved_variables.cfg

# [gcode_macro SAVE_PRINT_STATE]
# description: Save current print state for power loss recovery
# gcode:
#     SAVE_VARIABLE VARIABLE=print_z VALUE={printer.toolhead.position.z}
#     SAVE_VARIABLE VARIABLE=print_e VALUE={printer.toolhead.position.e}
#     SAVE_VARIABLE VARIABLE=print_file VALUE='"{printer.print_stats.filename}"'

# ============================================
# FILAMENT SENSOR (Optional)
# ============================================
# If you have a filament sensor, you can auto-pause on runout

# [filament_switch_sensor filament_sensor]
# switch_pin: ^PC15  # Adjust pin for your board
# pause_on_runout: True
# runout_gcode:
#     M600  # Filament change macro
# insert_gcode:
#     { action_respond_info("Filament Detected") }

# [gcode_macro M600]
# description: Filament change
# gcode:
#     {% set X = params.X|default(10)|float %}
#     {% set Y = params.Y|default(10)|float %}
#     {% set Z = params.Z|default(10)|float %}
#
#     SAVE_GCODE_STATE NAME=M600_state
#     PAUSE
#     G91
#     G1 E-2 F300
#     G1 Z{Z}
#     G90
#     G1 X{X} Y{Y} F6000

# ============================================
# DISPLAY MESSAGES (Optional)
# ============================================
# Custom messages for LCD display

# [display_template _print_status]
# text:
#     {% if printer.print_stats.state == "printing" %}
#         Printing: {printer.print_stats.filename}
#         Z: {printer.toolhead.position.z:.2f}mm
#     {% elif printer.print_stats.state == "paused" %}
#         PAUSED - Ready to Resume
#     {% else %}
#         Ready
#     {% endif %}

# ============================================
# PRINTER-SPECIFIC ADJUSTMENTS
# ============================================

# For Ender 3 / Ender 3 V2
# [safe_z_home]
# home_xy_position: 110,110
# z_hop: 10

# For Prusa i3 MK3S
# [safe_z_home]
# home_xy_position: 110,0  # Bed moves in Y
# z_hop: 10

# For Voron 2.4 (300x300)
# [safe_z_home]
# home_xy_position: 150,150
# z_hop: 10

# For CR-10 / CR-10S (300x300)
# [safe_z_home]
# home_xy_position: 150,150
# z_hop: 10

# For Artillery Sidewinder X1/X2 (300x300)
# [safe_z_home]
# home_xy_position: 150,150
# z_hop: 10

# ============================================
# NOTES
# ============================================
# 1. Always test the SAFE_Z_HOME position with your printer
# 2. Make sure the position is clear of any obstacles
# 3. Adjust Z_hop height based on your print height needs
# 4. Test PREPARE_RESUME macro before actual use
# 5. Keep original G-code files for reprocessing if needed
